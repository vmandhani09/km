import flaskimport osclass Internal:    def __init__(self, key_store):        self.key_store = key_store    def get_kme_status(self):        """Return comprehensive KME status including shared pool information"""        from keys.shared_key_pool import get_shared_pool_server                kme_id = os.getenv('KME_ID', '1')        attached_sae_id = os.getenv('ATTACHED_SAE_ID', '')                # Get shared pool status        try:            pool_server = get_shared_pool_server()            pool_status = {                'pool_size': len(pool_server.key_pool),                'max_capacity': pool_server.max_size,                'batch_size': pool_server.batch_size,                'threshold': pool_server.threshold,                'is_generating': pool_server.is_generating            }        except Exception as e:            # If pool server not available, return error status            pool_status = {                'error': str(e),                'pool_size': 0,                'max_capacity': 0            }                # Determine role based on KME_ID        role = "MASTER (Generator)" if kme_id == "1" else "SLAVE (Consumer)"                return {            'status': 'ok',            'KME_ID': kme_id,            'SAE_ID': attached_sae_id,            'role': role,            'shared_pool': pool_status        }    def get_key_pool(self):        # Placeholder for key pool endpoint        return {'key_pool': 'ok'}    def do_kme_key_exchange(self, request: flask.Request):        # Receives broadcasted keys from other KMEs        data = request.get_json()        master_sae_id = data.get('master_sae_id')        slave_sae_id = data.get('slave_sae_id')        keys = data.get('keys', [])        if not master_sae_id or not slave_sae_id or not keys:            return {'message': 'Missing required fields'}, 400        print(f"[KEY EXCHANGE] Received broadcasted keys:")        print(f"  master_sae_id: {master_sae_id}")        print(f"  slave_sae_id: {slave_sae_id}")        print(f"  keys: {[k['key_ID'] for k in keys]}")        # Store the received keys in the key store (no broadcast)        self.key_store.append_keys(master_sae_id, slave_sae_id, keys, do_broadcast=False)        print(f"[KEY EXCHANGE] Stored {len(keys)} keys for ({master_sae_id}, {slave_sae_id})")        return {'message': f'Received and stored {len(keys)} keys.'}, 200    def do_remove_kme_key(self, request: flask.Request):        # Receives key removal requests from other KMEs        data = request.get_json()        master_sae_id = data.get('master_sae_id')        slave_sae_id = data.get('slave_sae_id')        keys = data.get('keys', [])        if not master_sae_id or not slave_sae_id or not keys:            return {'message': 'Missing required fields'}, 400        self.key_store.remove_keys(master_sae_id, slave_sae_id, keys, do_broadcast=False)        return {'message': f'Removed {len(keys)} keys.'}, 200