# Deploy Next Door Key Simulator to Render.comThis guide explains how to deploy the ETSI QKD 014 compliant Next Door Key Simulator to Render.com, so your QuMail backend can use cloud-hosted KME servers.## Prerequisites- GitHub account- Render.com account (free tier is sufficient)- Git installed locally## Architecture```QuMail Backend (Local)    Γåô    Γö£ΓöÇΓåÆ KME 1 (Sender) on Render.com    Γöé   ΓööΓöÇΓåÆ Generates quantum keys    Γöé    ΓööΓöÇΓåÆ KME 2 (Receiver) on Render.com        ΓööΓöÇΓåÆ Retrieves quantum keys from shared pool```## Step 1: Prepare the Repository### Option A: Push to Your GitHub RepositoryIf you already have this project in a GitHub repository:```powershellcd "d:\New folder (8)\qumail-secure-email"git add next-door-key-simulator/git commit -m "Add Next Door Key Simulator for Render deployment"git push origin master```### Option B: Create a New RepositoryIf you don't have this in GitHub yet:```powershellcd "d:\New folder (8)\qumail-secure-email\next-door-key-simulator"git initgit add .git commit -m "Initial commit: Next Door Key Simulator"git remote add origin https://github.com/YOUR_USERNAME/next-door-key-simulator.gitgit push -u origin master```## Step 2: Deploy KME 1 (Sender) on Render1. **Go to Render Dashboard**: https://dashboard.render.com/2. **Create New Web Service**:   - Click "New +" ΓåÆ "Web Service"   - Connect your GitHub repository   - Select the repository containing `next-door-key-simulator`3. **Configure KME 1 (Sender)**:   - **Name**: `qumail-kme-sender`   - **Region**: Oregon (or closest to you)   - **Branch**: `master` (or `main`)   - **Root Directory**: `next-door-key-simulator` (if in a monorepo)   - **Runtime**: Docker   - **Plan**: Free4. **Environment Variables** (Add these in Render dashboard):   ```   HOST=0.0.0.0   PORT=10000   USE_HTTPS=false   KME_ID=1   ATTACHED_SAE_ID=25840139-0dd4-49ae-ba1e-b86731601803   DEFAULT_KEY_SIZE=32   MAX_KEY_COUNT=1000   KEY_GEN_BATCH_SIZE=100   KEY_GEN_SEC_TO_GEN=1.0   REFILL_THRESHOLD=500   MAX_KEYS_PER_REQUEST=128   MAX_KEY_SIZE=1024   MIN_KEY_SIZE=32   KEY_ACQUIRE_TIMEOUT=10   NETWORK_TIMEOUT=10   OTHER_KMES=https://qumail-kme-receiver.onrender.com   ```5. **Health Check Path**: `/api/v1/kme/status`6. **Click "Create Web Service"**7. **Wait for deployment** (5-10 minutes for first deployment)8. **Note the URL**: `https://qumail-kme-sender.onrender.com`## Step 3: Deploy KME 2 (Receiver) on Render1. **Create Another Web Service**:   - Click "New +" ΓåÆ "Web Service"   - Connect the same GitHub repository2. **Configure KME 2 (Receiver)**:   - **Name**: `qumail-kme-receiver`   - **Region**: Oregon (same as KME 1)   - **Branch**: `master` (or `main`)   - **Root Directory**: `next-door-key-simulator` (if in a monorepo)   - **Runtime**: Docker   - **Plan**: Free3. **Environment Variables** (Add these in Render dashboard):   ```   HOST=0.0.0.0   PORT=10000   USE_HTTPS=false   KME_ID=2   ATTACHED_SAE_ID=c565d5aa-8670-4446-8471-b0e53e315d2a   DEFAULT_KEY_SIZE=32   MAX_KEY_COUNT=1000   KEY_GEN_BATCH_SIZE=100   KEY_GEN_SEC_TO_GEN=1.0   REFILL_THRESHOLD=500   MAX_KEYS_PER_REQUEST=128   MAX_KEY_SIZE=1024   MIN_KEY_SIZE=32   KEY_ACQUIRE_TIMEOUT=10   NETWORK_TIMEOUT=10   OTHER_KMES=https://qumail-kme-sender.onrender.com   ```4. **Health Check Path**: `/api/v1/kme/status`5. **Click "Create Web Service"**6. **Wait for deployment** (5-10 minutes)7. **Note the URL**: `https://qumail-kme-receiver.onrender.com`## Step 4: Update Backend ConfigurationUpdate your backend `.env` file to use the new Render URLs:```powershellcd "d:\New folder (8)\qumail-secure-email\qumail-backend"```Edit `.env` and change:```envKM1_BASE_URL=https://qumail-kme-sender.onrender.comKM2_BASE_URL=https://qumail-kme-receiver.onrender.com```## Step 5: Verify DeploymentTest the deployed KME servers:```powershell# Test KME 1 (Sender)Invoke-WebRequest -Uri "https://qumail-kme-sender.onrender.com/api/v1/kme/status"# Test KME 2 (Receiver)Invoke-WebRequest -Uri "https://qumail-kme-receiver.onrender.com/api/v1/kme/status"```Expected response:```json{  "status": "ok",  "kme_id": "1" // or "2" for receiver  ...}```## Step 6: Test ETSI QKD 014 APITest the ETSI QKD 014 compliant endpoints:```powershell# Test status endpoint (Sender)Invoke-WebRequest -Uri "https://qumail-kme-sender.onrender.com/api/v1/keys/c565d5aa-8670-4446-8471-b0e53e315d2a/status"# Test key generation (Sender)$body = @{    number = 2    size = 32} | ConvertTo-JsonInvoke-WebRequest -Uri "https://qumail-kme-sender.onrender.com/api/v1/keys/c565d5aa-8670-4446-8471-b0e53e315d2a/enc_keys" `    -Method POST `    -Body $body `    -ContentType "application/json"```## Step 7: Test with BackendRun the cloud KME connectivity test:```powershellcd "d:\New folder (8)\qumail-secure-email\qumail-backend"python test_cloud_kme.py```## Troubleshooting### Issue: "Service Unavailable" or 503 errors**Solution**: Render free tier services sleep after 15 minutes of inactivity. The first request will wake them up (takes 30-60 seconds). Subsequent requests will be fast.### Issue: Connection timeout**Solution**: 1. Check Render logs: Dashboard ΓåÆ Service ΓåÆ Logs2. Verify environment variables are correct3. Ensure `USE_HTTPS=false` (Render handles HTTPS at the edge)### Issue: "OTHER_KMES connection failed"**Solution**: Both KME servers must be deployed and running. Deploy KME 1 first, then KME 2.### Issue: Backend still getting 404 errors**Solution**: 1. Verify URLs in backend `.env` match Render URLs2. Restart backend server3. Check that `verify_ssl=False` is set in `kme_service.py`## Alternative: Use render.yaml (Blueprint)If you want to deploy both KMEs at once using Infrastructure as Code:1. Copy `render-kme1.yaml` or `render-kme2.yaml` to the root of your repository as `render.yaml`2. Modify to include both services:```yamlservices:  - type: web    name: qumail-kme-sender    runtime: docker    region: oregon    plan: free    rootDir: next-door-key-simulator    dockerfilePath: ./Dockerfile    dockerContext: .    envVars:      # ... KME 1 env vars ...    healthCheckPath: /api/v1/kme/status  - type: web    name: qumail-kme-receiver    runtime: docker    region: oregon    plan: free    rootDir: next-door-key-simulator    dockerfilePath: ./Dockerfile    dockerContext: .    envVars:      # ... KME 2 env vars ...    healthCheckPath: /api/v1/kme/status```3. In Render Dashboard:   - Click "New +" ΓåÆ "Blueprint"   - Connect your repository   - Render will automatically deploy both services## Performance Considerations### Render Free Tier Limitations- **Cold starts**: Services sleep after 15 minutes of inactivity- **First request latency**: 30-60 seconds to wake up- **Spin down**: Services auto-sleep on free tier- **Monthly hours**: 750 hours/month per service (plenty for testing)### Production RecommendationsFor production use, upgrade to Render's paid plans:- **Starter ($7/month)**: No cold starts, always-on- **Standard ($25/month)**: Better performance, more resources- Deploy in same region as your backend for lower latency## Cost Estimate**Free Tier (Current Setup)**:- KME 1 (Sender): $0/month- KME 2 (Receiver): $0/month- **Total**: $0/month**Paid Tier (Recommended for Production)**:- KME 1 (Sender): $7/month (Starter plan)- KME 2 (Receiver): $7/month (Starter plan)- **Total**: $14/month## Next Steps1. Γ£à Deploy KME 1 (Sender) to Render2. Γ£à Deploy KME 2 (Receiver) to Render3. Γ£à Update backend `.env` with Render URLs4. Γ£à Test connectivity with `test_cloud_kme.py`5. Γ£à Start backend and frontend6. Γ£à Test full email encryption flow7. ≡ƒô¥ Document Render URLs for team## SupportIf you encounter issues:1. Check Render service logs2. Verify environment variables3. Test with curl/Invoke-WebRequest4. Review backend logs for connection errors5. Ensure both KME services are deployed and running## Security Notes- **HTTP Mode**: We're using `USE_HTTPS=false` because Render provides HTTPS at the edge- **SSL Verification**: Backend has `verify_ssl=False` to handle Render's certificates- **Authentication**: ETSI QKD 014 API doesn't require auth for testing- **For Production**: Consider adding API key authentication or IP whitelisting in Render settings